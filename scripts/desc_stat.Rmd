---
title: "Descriptive Statistics"
author: "ACHIQ Aya, CLETZ Laura, ZHU Qingjian"
date: "2025-11-21"
output: pdf_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

Before starting to impute data, we need to observe the structure of the processed data "TABLE_TO_IMPUTE.csv". We want to see which variables or levels of those variables are related to the Missing Data (MD). We will thus count and statistically describe the data by group: individuals with MD and individuals without.

## Data loading

```{r}
library(readr)
data <- read_delim("../data/TABLE_TO_IMPUTE.csv", col_names=T, show_col_types=F)
head(data)
```

```{r}
str(data)
```

We mutate every categorical and binary variables as factors:

```{r}
library(dplyr)
data <- data %>% mutate_at(c(2:9,12:20), as.factor)
str(data)
```

## Count

```{r}
na_index <- which(is.na(data["RRT_ever"]))
head(data[na_index,])
```

There is $80/400=0.2=20\%$ of MD in the RRT_ever variable, it's completely manageable.

```{r}
summary(data[na_index,])
```

At first sight, chronic hypertension, sex, sepsis at inclusion, AKIN score at inclusion and the arm the patient was included in don't seem of particular interest (distribution 50/50 or almost). We can remove them from the variables needed for the imputation stage. Exactly half the individuals with MD are in arm A (and of course, the other half in B), which can be reassuring when we will be at analysis stage. We could maybe turn the quantitative data into qualitative.

## Distribution

In order to be able to see the distribution of missing values, we create a new variable: if there is a NA, then the data is "Missing" and if there is 0 or 1, then the data is "Observed":

```{r}
data <- data %>%
  mutate(RRT_MD = ifelse(is.na(RRT_ever), "Missing", "Observed"))
```

### Qualitative 

```{r}
library(ggplot2)
library(purrr)

# Create a ggplot for each explanatory variable:
plots_cat <- map(names(data)[c(2:9,12:19)], function(x){
  var <- sym(x)       # converts the character variable name as a symbol       
  data %>%
    group_by(!!var, RRT_MD) %>%      # !! is an injection operator turning symbols to usable expressions
    summarise(n = n(), .groups = "drop") %>%     # n() gives the current group size
    mutate(p = n / sum(n)) %>%       # calculate proportions
    ggplot(aes(x = !!var, y = p, fill = RRT_MD)) +      # ggplot to view proportions of missing and observed related to categorical explanatory variable
    geom_col(position = "fill") +
    scale_y_continuous(labels = scales::percent) +     # proportion converted to percentage for readability
    labs(
      title = paste("Missingness of RRT information by", x),
      y = "% Missing vs Observed"
    ) +
    theme_minimal() +
    scale_fill_manual(values = c('#2F3CA8','#75F1FF'))
}) 

for(i in 1:length(plots_cat)){
  print(plots_cat[[i]])        # show every ggplot
  }
```

It seems that MD may happen more often if:

- the SOFA score below 4 (no renal failure);
- the patient is a man or a woman;
- the patient is old.

So, maybe most MD comes from patients that don't need RRT because their organ are still safe or, on the opposite side, they come from patients that usually need RRT because they are too old and tired to be able to live through the treatment and still naturally filtrate their blood.

### Quantitative

```{r}
ggplot(data, aes(x = INCL_LAB_serum_creatinine, color = RRT_MD)) +
  geom_density() +
  labs(title = "Distribution of serum creatinine by RRT information missingness") +
  theme_minimal()

ggplot(data, aes(x = INCL_LAB_blood_urea_nitrogen, color = RRT_MD)) +
  geom_density() +
  labs(title = "Distribution of blood urea nitrogen by RRT information missingness") +
  theme_minimal()
```

Both densities look gaussian, there might be an equal distribution of missing and observed over the quantitative variables. The BUN might show interesting modalities.

In **Clinical review: Timing of renal replacement therapy** published in *Critical Care* in 2011 by *M. Joannidis* and *L. G. Forni* (https://doi.org/10.1186/cc10109), it is said that:
"RRT is usually initiated at BUN levels between 50 mg/dl and 110 mg/dl (approximate to 18 to 40 mmol/l) or a serum creatinine between 3.5 and 5 mg/dl."
So, maybe most MD comes from patients that clearly don't need RRT due to their low BUN.

## FA (Factorial Analysis)

We have seen counts, distributions, and now we will precise our previous observations with a Factorial Analysis. We want all variables to be categorical, thus we convert our two quantitative variables as 4-levels qualitative variables and we choose the quantiles as levels breaks:

```{r}
data <- data %>%
  mutate(
    cat_creatinine = cut(
      INCL_LAB_serum_creatinine,
      breaks = quantile(INCL_LAB_serum_creatinine[na_index], probs = c(0, 0.25, 0.5, 0.75, 1)),
      include.lowest = TRUE,
      labels = c("<1.4", "1.4-1.7", "1.7-2.0", ">2.0")
    ),
    cat_blood_urea = cut(
      INCL_LAB_blood_urea_nitrogen,
      breaks = quantile(INCL_LAB_blood_urea_nitrogen[na_index], probs = c(0, 0.25, 0.5, 0.75, 1)),
      include.lowest = TRUE,
      labels = c("<23.95", "23.95-29.55", "29.55-35.52", ">35.52")
    )
  )
```

We add the missing values `NA` as another level of the variable `RRT_ever` and we convert the whole table as a complete disjunctive table:

```{r}
library(ade4)
disj <- data[-c(1,10:11,21)] %>% mutate_at("RRT_ever", addNA) %>% as.data.frame()
disj <- acm.disjonctif(disj)
head(disj)
```

We are now able to realize a FA on this table:

```{r}
library(FactoMineR)
res.fa <- CA(disj, graph=F)
barplot(res.fa$eig[,2])
```

It's hard to choose the right number of dimensions, we will then look at the first dimensions and try to explain it the best we can.

```{r}
library(factoextra)

# Color scheme: 
col_group <- rep("blue", ncol(disj))
RRT_index <- grep("RRT_ever", names(disj)) 
col_group[RRT_index] <- "red"

# Plot first FA axis columns only:
plot(res.fa, axes=1:2, invisible = "row", repel=T,
     col.col = col_group)
```

```{r}
plot(res.fa, axes=c(1,3), invisible = "row", repel=T,
     col.col = col_group)
```

```{r}
plot(res.fa, axes=2:3, invisible = "row", repel=T,
     col.col = col_group)
```

The variables related to sepsis at inclusion and sex don't help much, we add them as illustrative variables.

```{r}
# Indexes for illustrative variables
illu_var <- c(grep("SEPSIS", names(disj)), grep("SEX", names(disj)))
res.fa <- CA(disj, graph=F, col.sup = illu_var)
```

```{r}
# Color scheme:
col_group <- rep("blue", ncol(disj))
col_group[RRT_index] <- "red"
col_group <- col_group[-illu_var]     # illustrative variables removed to avoid `col.col` parameter error

plot(res.fa, axes=1:2, invisible = "row", repel=T,
     col.col = col_group, col.col.sup = "darkgreen")    # illustrative variables in green
```

```{r}
plot(res.fa, axes=c(1,3), invisible = "row", repel=T,
     col.col = col_group, col.col.sup = "darkgreen")
```

The variables related to sepsis at inclusion and liver insufficiency don't help much here, we add them as illustrative variables.

```{r}
illu_var <- c(illu_var, c(grep("liver", names(disj)), grep("SOFA", names(disj))))
res.fa <- CA(disj, graph=F, col.sup=illu_var)
```

```{r}
col_group <- rep("blue", ncol(disj))
col_group[RRT_index] <- "red"
col_group <- col_group[-illu_var]

plot(res.fa, axes=1:2, invisible = "row", repel=T,
     col.col = col_group, col.col.sup = "darkgreen")
```

The barycenters are overlaid on each other.

```{r}
plot(res.fa, axes=c(1,3), invisible = "row", repel=T,
     col.col = col_group, col.col.sup = "darkgreen")
```

```{r}
plot(res.fa, axes=2:3, invisible = "row", repel=T,
     col.col = col_group, col.col.sup = "darkgreen")
```

```{r}
plot(res.fa, axes=c(1,4), invisible = "row", repel=T,
     col.col = col_group, col.col.sup = "darkgreen")
```

```{r}
plot(res.fa, axes=c(2,4), invisible = "row", repel=T,
     col.col = col_group, col.col.sup = "darkgreen")
```

```{r}
plot(res.fa, axes=c(3,4), invisible = "row", repel=T,
     col.col = col_group, col.col.sup = "darkgreen")
```

```{r}
plot(res.fa, axes=c(1,5), invisible = "row", repel=T,
     col.col = col_group, col.col.sup = "darkgreen")
```

```{r}
plot(res.fa, axes=c(2,5), invisible = "row", repel=T,
     col.col = col_group, col.col.sup = "darkgreen")
```

```{r}
plot(res.fa, axes=c(3,5), invisible = "row", repel=T,
     col.col = col_group, col.col.sup = "darkgreen")
```

```{r}
plot(res.fa, axes=c(4,5), invisible = "row", repel=T,
     col.col = col_group, col.col.sup = "darkgreen")
```

This is still a little confusing. MD may be related to patients with:

- low and mid BUN;
- high serum creatinine;
- old age;
- cirrhosis;
- kidney disease;
- hypertension;
and patient that died.

Some of those variables are similar to the ones observed in the "Distribution" part. But this time, we also have clues about which comorbidities may affect the need to RRT. It seems logical that patients that had a kidney disease may be there for a similar problem that requires RRT or that there is a chance to kidney failure during their stay in ICU that might be avoidable with RRT.

## Conclusion

We tried various methods in order to select variables for the imputations. 
We thus keep:

- AGE_CLASS
- SEX
- ATCD_Chronic_hypertension
- ATCD_Ckidney_disease
- INCL_LAB_serum_creatinine
- INCL_LAB_blood_urea_nitrogen
- INCL_SEPSIS_YN
- SOFA_renal_H0
- SOFA_renal_D7

(We will not convert the quantitative variables in our imputation's models.)

### For poster

```{r}
names(data) <- c("SUBJID", "Smoking", "Diabetes", "Chr. hypertension", "Chr. heart failure",
                 "Chr. kidney disease", "Sever liver ins.", "Cirrhosis", "Immunocomp.",
                 "nope", "nope", "Sex", "Sepsis", "Age class", "AKIN",
                 "Arm", "SOFA renal", "SOFA renal 2", "Death", "RRT", 
                 "RRT 2", "Se. creatinine", "BUN")

disj <- data[-c(1,10:11,21)] %>% mutate_at("RRT", addNA) %>% as.data.frame()
disj <- acm.disjonctif(disj)

res.fa <- CA(disj, graph=F, col.sup=illu_var)
```

```{r}
col_group <- rep("#2F3CA8", ncol(disj))
col_group[RRT_index] <- "red"
col_group <- col_group[-illu_var]

p <- plot(res.fa, axes=2:3, invisible = "row", repel=T, 
     col.col = col_group, col.col.sup = "#75F1FF", label="col")

p + theme_void() 
```



