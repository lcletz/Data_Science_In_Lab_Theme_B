---
title: "Logistic Regression Imputation"
author: "ACHIQ Aya, CLETZ Laura, ZHU Qingjian"
date: "2025-11-26"
output: pdf_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

## Data loading 

We require the `TABLE_TO_IMPUTE.csv` obtained via `\data_processing` in order to realize multiple imputation by chained equations.
The variables that will be used in the imputation models are chosen following `desc_stat.Rmd` and chi-squared tests results:

```{r}
library(readr)
library(dplyr)
library(mice)

data <- read_delim("../data/TABLE_TO_IMPUTE.csv", show_col_types = FALSE)

vars_mice <- c(
  "RRT_ever", 
  "AGE_CLASS", 
  "SEX",
  "ATCD_Chronic_hypertension",
  "ATCD_Ckidney_disease",
  "INCL_LAB_serum_creatinine",
  "INCL_LAB_blood_urea_nitrogen",
  "INCL_SEPSIS_YN",
  "SOFA_renal_H0",
  "SOFA_renal_D7"
)
```

## Imputation

We will try to impute by a MICE-based random forest the variable `RRT_ever` since it's the only one with missing values.

```{r}
meth <- make.method(data)
meth["RRT_ever"] <- "logreg"
```

We create a matrix of predictors using every available variable but only allowing the previously chosen variables to be used during the imputation:

```{r}
pred <- make.predictorMatrix(data)
pred[,] <- 0
pred["RRT_ever", setdiff(vars_mice, "RRT_ever")] <- 1
```

We are now ready to impute those missing values, we chose `m=20` since, according to the *Von Hippel (2009)* rule of thumb, "the number of imputations should be similar to the percentage of cases that are incomplete" which is 20% here.

```{r}
imp_rrt <- mice(
  data,
  m = 20,    # because of 20% missing data
  maxit = 20,
  method = meth,
  predictorMatrix = pred,
  seed=1234
)
```

## Before comparing imputations

There is no way to find the "perfect" table between the 20 obtained since `RRT_ever` is a binary variable (we could think of a majority vote but we lack bibliography). We still want to compare the logistic regression imputed datasets with our random forest ones. We will then choose between our 20 datasets, the ones with similar proportions of 1 (of patients with RRT) when compared to the original, non-imputed dataset.

```{r}
na_index <- which(is.na(data$RRT_ever))
sum(data[-na_index,]$RRT_ever==1)/nrow(data[-na_index,])
```

```{r}
for (i in 1:20){
  cat("Imputed dataset #", i, "\n")
  imputed_data <- complete(imp_rrt, i)
  print(sum(imputed_data$RRT_ever==1)/nrow(data))
}
```

The original data's porportion of patient that needed a RRT is 0.575.
The proportion for an imputed dataset that is nearer to it is 0.575 and corresponds to the 9th and 11th datasets.

We will compare the 9th imputed dataset with similar proportion's random forest imputed dataset.

```{r}
write_delim(complete(imp_rrt, 9), "../data/LOGREG_IMPUTED_DATA.csv", delim=";")
```

The comparison is established in `imputation_comparison.Rmd` file.